


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ObjectReaderProvider</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.alibaba.fastjson2.reader</a>
</div>

<h1>Coverage Summary for Class: ObjectReaderProvider (com.alibaba.fastjson2.reader)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ObjectReaderProvider</td>
<td class="coverageStat">
  <span class="percent">
    93.1%
  </span>
  <span class="absValue">
    (54/58)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    87.9%
  </span>
  <span class="absValue">
    (421/479)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ObjectReaderProvider$LRUAutoTypeCache</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ObjectReaderProvider$ObjectReaderCachePair</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    93.4%
  </span>
  <span class="absValue">
    (57/61)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    88%
  </span>
  <span class="absValue">
    (427/485)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.alibaba.fastjson2.reader;
&nbsp;
&nbsp;import com.alibaba.fastjson2.*;
&nbsp;import com.alibaba.fastjson2.JSONReader.AutoTypeBeforeHandler;
&nbsp;import com.alibaba.fastjson2.codec.BeanInfo;
&nbsp;import com.alibaba.fastjson2.codec.FieldInfo;
&nbsp;import com.alibaba.fastjson2.function.FieldBiConsumer;
&nbsp;import com.alibaba.fastjson2.function.FieldConsumer;
&nbsp;import com.alibaba.fastjson2.modules.ObjectCodecProvider;
&nbsp;import com.alibaba.fastjson2.modules.ObjectReaderAnnotationProcessor;
&nbsp;import com.alibaba.fastjson2.modules.ObjectReaderModule;
&nbsp;import com.alibaba.fastjson2.support.LambdaMiscCodec;
&nbsp;import com.alibaba.fastjson2.util.BeanUtils;
&nbsp;import com.alibaba.fastjson2.util.Fnv;
&nbsp;import com.alibaba.fastjson2.util.JDKUtils;
&nbsp;import com.alibaba.fastjson2.util.TypeUtils;
&nbsp;
&nbsp;import java.lang.annotation.Annotation;
&nbsp;import java.lang.reflect.*;
&nbsp;import java.util.*;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;import java.util.concurrent.atomic.AtomicReference;
&nbsp;import java.util.function.Consumer;
&nbsp;import java.util.function.Function;
&nbsp;import java.util.function.Supplier;
&nbsp;
&nbsp;import static com.alibaba.fastjson2.JSONFactory.*;
&nbsp;import static com.alibaba.fastjson2.util.Fnv.MAGIC_HASH_CODE;
&nbsp;import static com.alibaba.fastjson2.util.Fnv.MAGIC_PRIME;
&nbsp;import static com.alibaba.fastjson2.util.TypeUtils.loadClass;
&nbsp;
&nbsp;public class ObjectReaderProvider
&nbsp;        implements ObjectCodecProvider {
<b class="fc">&nbsp;    static final ClassLoader FASTJSON2_CLASS_LOADER = JSON.class.getClassLoader();</b>
&nbsp;    public static final boolean SAFE_MODE;
&nbsp;    static final String[] DENYS;
&nbsp;    static final String[] AUTO_TYPE_ACCEPT_LIST;
&nbsp;
&nbsp;    static AutoTypeBeforeHandler DEFAULT_AUTO_TYPE_BEFORE_HANDLER;
&nbsp;    static Consumer&lt;Class&gt; DEFAULT_AUTO_TYPE_HANDLER;
&nbsp;    static boolean DEFAULT_AUTO_TYPE_HANDLER_INIT_ERROR;
&nbsp;
&nbsp;    static ObjectReaderCachePair readerCache;
&nbsp;
&nbsp;    static class ObjectReaderCachePair {
&nbsp;        final long hashCode;
&nbsp;        final ObjectReader reader;
&nbsp;        volatile int missCount;
&nbsp;
<b class="fc">&nbsp;        public ObjectReaderCachePair(long hashCode, ObjectReader reader) {</b>
<b class="fc">&nbsp;            this.hashCode = hashCode;</b>
<b class="fc">&nbsp;            this.reader = reader;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    static {
&nbsp;        {
<b class="fc">&nbsp;            String property = System.getProperty(PROPERTY_DENY_PROPERTY);</b>
<b class="fc">&nbsp;            if (property == null) {</b>
<b class="fc">&nbsp;                property = JSONFactory.getProperty(PROPERTY_DENY_PROPERTY);</b>
&nbsp;            }
<b class="fc">&nbsp;            if (property != null &amp;&amp; property.length() &gt; 0) {</b>
<b class="nc">&nbsp;                DENYS = property.split(&quot;,&quot;);</b>
&nbsp;            } else {
<b class="fc">&nbsp;                DENYS = new String[0];</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        {
<b class="fc">&nbsp;            String property = System.getProperty(PROPERTY_AUTO_TYPE_ACCEPT);</b>
<b class="fc">&nbsp;            if (property == null) {</b>
<b class="fc">&nbsp;                property = JSONFactory.getProperty(PROPERTY_AUTO_TYPE_ACCEPT);</b>
&nbsp;            }
<b class="fc">&nbsp;            if (property != null &amp;&amp; property.length() &gt; 0) {</b>
<b class="nc">&nbsp;                AUTO_TYPE_ACCEPT_LIST = property.split(&quot;,&quot;);</b>
&nbsp;            } else {
<b class="fc">&nbsp;                AUTO_TYPE_ACCEPT_LIST = new String[0];</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        {
<b class="fc">&nbsp;            String property = System.getProperty(PROPERTY_AUTO_TYPE_BEFORE_HANDLER);</b>
<b class="fc">&nbsp;            if (property == null || property.isEmpty()) {</b>
<b class="fc">&nbsp;                property = JSONFactory.getProperty(PROPERTY_AUTO_TYPE_BEFORE_HANDLER);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (property != null) {</b>
<b class="nc">&nbsp;                property = property.trim();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (property != null &amp;&amp; !property.isEmpty()) {</b>
<b class="nc">&nbsp;                Class handlerClass = TypeUtils.loadClass(property);</b>
<b class="nc">&nbsp;                if (handlerClass != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        DEFAULT_AUTO_TYPE_BEFORE_HANDLER = (AutoTypeBeforeHandler) handlerClass.newInstance();</b>
<b class="nc">&nbsp;                    } catch (Exception ignored) {</b>
<b class="nc">&nbsp;                        DEFAULT_AUTO_TYPE_HANDLER_INIT_ERROR = true;</b>
&nbsp;                        // skip
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        {
<b class="fc">&nbsp;            String property = System.getProperty(PROPERTY_AUTO_TYPE_HANDLER);</b>
<b class="fc">&nbsp;            if (property == null || property.isEmpty()) {</b>
<b class="fc">&nbsp;                property = JSONFactory.getProperty(PROPERTY_AUTO_TYPE_HANDLER);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (property != null) {</b>
<b class="nc">&nbsp;                property = property.trim();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (property != null &amp;&amp; !property.isEmpty()) {</b>
<b class="nc">&nbsp;                Class handlerClass = TypeUtils.loadClass(property);</b>
<b class="nc">&nbsp;                if (handlerClass != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        DEFAULT_AUTO_TYPE_HANDLER = (Consumer&lt;Class&gt;) handlerClass.newInstance();</b>
<b class="nc">&nbsp;                    } catch (Exception ignored) {</b>
<b class="nc">&nbsp;                        DEFAULT_AUTO_TYPE_HANDLER_INIT_ERROR = true;</b>
&nbsp;                        // skip
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        {
<b class="fc">&nbsp;            String property = System.getProperty(&quot;fastjson.parser.safeMode&quot;);</b>
<b class="fc">&nbsp;            if (property == null || property.isEmpty()) {</b>
<b class="fc">&nbsp;                property = JSONFactory.getProperty(&quot;fastjson.parser.safeMode&quot;);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (property == null || property.isEmpty()) {</b>
<b class="fc">&nbsp;                property = System.getProperty(&quot;fastjson2.parser.safeMode&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            if (property == null || property.isEmpty()) {</b>
<b class="fc">&nbsp;                property = JSONFactory.getProperty(&quot;fastjson2.parser.safeMode&quot;);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (property != null) {</b>
<b class="nc">&nbsp;                property = property.trim();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            SAFE_MODE = &quot;true&quot;.equals(property);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    final ConcurrentMap&lt;Type, ObjectReader&gt; cache = new ConcurrentHashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    final ConcurrentMap&lt;Type, ObjectReader&gt; cacheFieldBased = new ConcurrentHashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    final ConcurrentMap&lt;Integer, ConcurrentHashMap&lt;Long, ObjectReader&gt;&gt; tclHashCaches = new ConcurrentHashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    final ConcurrentMap&lt;Long, ObjectReader&gt; hashCache = new ConcurrentHashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    final ConcurrentMap&lt;Class, Class&gt; mixInCache = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;    final LRUAutoTypeCache autoTypeList = new LRUAutoTypeCache(1024);</b>
&nbsp;
<b class="fc">&nbsp;    private final ConcurrentMap&lt;Type, Map&lt;Type, Function&gt;&gt; typeConverts = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    final ObjectReaderCreator creator;
<b class="fc">&nbsp;    final List&lt;ObjectReaderModule&gt; modules = new ArrayList&lt;&gt;();</b>
&nbsp;
&nbsp;    private long[] acceptHashCodes;
&nbsp;
<b class="fc">&nbsp;    private AutoTypeBeforeHandler autoTypeBeforeHandler = DEFAULT_AUTO_TYPE_BEFORE_HANDLER;</b>
<b class="fc">&nbsp;    private Consumer&lt;Class&gt; autoTypeHandler = DEFAULT_AUTO_TYPE_HANDLER;</b>
&nbsp;
&nbsp;    {
&nbsp;        long[] hashCodes;
<b class="fc">&nbsp;        if (AUTO_TYPE_ACCEPT_LIST == null) {</b>
<b class="nc">&nbsp;            hashCodes = new long[1];</b>
&nbsp;        } else {
<b class="fc">&nbsp;            hashCodes = new long[AUTO_TYPE_ACCEPT_LIST.length + 1];</b>
<b class="fc">&nbsp;            for (int i = 0; i &lt; AUTO_TYPE_ACCEPT_LIST.length; i++) {</b>
<b class="nc">&nbsp;                hashCodes[i] = Fnv.hashCode64(AUTO_TYPE_ACCEPT_LIST[i]);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        hashCodes[hashCodes.length - 1] = -6293031534589903644L;</b>
&nbsp;
<b class="fc">&nbsp;        Arrays.sort(hashCodes);</b>
<b class="fc">&nbsp;        acceptHashCodes = hashCodes;</b>
&nbsp;
<b class="fc">&nbsp;        hashCache.put(ObjectArrayReader.TYPE_HASH_CODE, ObjectArrayReader.INSTANCE);</b>
<b class="fc">&nbsp;        final long STRING_CLASS_NAME_HASH = -4834614249632438472L; // Fnv.hashCode64(String.class.getName());</b>
<b class="fc">&nbsp;        hashCache.put(STRING_CLASS_NAME_HASH, ObjectReaderImplString.INSTANCE);</b>
<b class="fc">&nbsp;        hashCache.put(Fnv.hashCode64(TypeUtils.getTypeName(HashMap.class)), ObjectReaderImplMap.INSTANCE);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void registerIfAbsent(long hashCode, ObjectReader objectReader) {
<b class="fc">&nbsp;        ClassLoader tcl = Thread.currentThread().getContextClassLoader();</b>
<b class="fc">&nbsp;        if (tcl != null &amp;&amp; tcl != JSON.class.getClassLoader()) {</b>
<b class="fc">&nbsp;            int tclHash = System.identityHashCode(tcl);</b>
<b class="fc">&nbsp;            ConcurrentHashMap&lt;Long, ObjectReader&gt; tclHashCache = tclHashCaches.get(tclHash);</b>
<b class="fc">&nbsp;            if (tclHashCache == null) {</b>
<b class="fc">&nbsp;                tclHashCaches.putIfAbsent(tclHash, new ConcurrentHashMap&lt;&gt;());</b>
<b class="fc">&nbsp;                tclHashCache = tclHashCaches.get(tclHash);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            tclHashCache.putIfAbsent(hashCode, objectReader);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        hashCache.putIfAbsent(hashCode, objectReader);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void addAutoTypeAccept(String name) {
<b class="fc">&nbsp;        if (name != null &amp;&amp; name.length() != 0) {</b>
<b class="fc">&nbsp;            long hash = Fnv.hashCode64(name);</b>
<b class="fc">&nbsp;            if (Arrays.binarySearch(this.acceptHashCodes, hash) &lt; 0) {</b>
<b class="fc">&nbsp;                long[] hashCodes = new long[this.acceptHashCodes.length + 1];</b>
<b class="fc">&nbsp;                hashCodes[hashCodes.length - 1] = hash;</b>
<b class="fc">&nbsp;                System.arraycopy(this.acceptHashCodes, 0, hashCodes, 0, this.acceptHashCodes.length);</b>
<b class="fc">&nbsp;                Arrays.sort(hashCodes);</b>
<b class="fc">&nbsp;                this.acceptHashCodes = hashCodes;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Deprecated
&nbsp;    public void addAutoTypeDeny(String name) {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    public Consumer&lt;Class&gt; getAutoTypeHandler() {
<b class="fc">&nbsp;        return autoTypeHandler;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setAutoTypeHandler(Consumer&lt;Class&gt; autoTypeHandler) {
<b class="fc">&nbsp;        this.autoTypeHandler = autoTypeHandler;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Class getMixIn(Class target) {
<b class="fc">&nbsp;        return mixInCache.get(target);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void cleanupMixIn() {
<b class="nc">&nbsp;        mixInCache.clear();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void mixIn(Class target, Class mixinSource) {
<b class="fc">&nbsp;        if (mixinSource == null) {</b>
<b class="fc">&nbsp;            mixInCache.remove(target);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            mixInCache.put(target, mixinSource);</b>
&nbsp;        }
<b class="fc">&nbsp;        cache.remove(target);</b>
<b class="fc">&nbsp;        cacheFieldBased.remove(target);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void registerSeeAlsoSubType(Class subTypeClass) {
<b class="nc">&nbsp;        registerSeeAlsoSubType(subTypeClass, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void registerSeeAlsoSubType(Class subTypeClass, String subTypeClassName) {
<b class="fc">&nbsp;        Class superClass = subTypeClass.getSuperclass();</b>
<b class="fc">&nbsp;        if (superClass == null) {</b>
<b class="nc">&nbsp;            throw new JSONException(&quot;superclass is null&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        ObjectReader objectReader = getObjectReader(superClass);</b>
<b class="fc">&nbsp;        if (objectReader instanceof ObjectReaderSeeAlso) {</b>
<b class="fc">&nbsp;            ObjectReaderSeeAlso readerSeeAlso = (ObjectReaderSeeAlso) objectReader;</b>
<b class="fc">&nbsp;            ObjectReaderSeeAlso readerSeeAlsoNew = readerSeeAlso.addSubType(subTypeClass, subTypeClassName);</b>
<b class="fc">&nbsp;            if (readerSeeAlsoNew != readerSeeAlso) {</b>
<b class="fc">&nbsp;                if (cache.containsKey(superClass)) {</b>
<b class="fc">&nbsp;                    cache.put(superClass, readerSeeAlsoNew);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    cacheFieldBased.put(subTypeClass, readerSeeAlsoNew);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader register(Type type, ObjectReader objectReader, boolean fieldBased) {
<b class="fc">&nbsp;        ConcurrentMap&lt;Type, ObjectReader&gt; cache = fieldBased ? this.cacheFieldBased : this.cache;</b>
<b class="fc">&nbsp;        if (objectReader == null) {</b>
<b class="fc">&nbsp;            return cache.remove(type);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return cache.put(type, objectReader);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader register(Type type, ObjectReader objectReader) {
<b class="fc">&nbsp;        return register(type, objectReader, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader registerIfAbsent(Type type, ObjectReader objectReader) {
<b class="fc">&nbsp;        return registerIfAbsent(type, objectReader, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader registerIfAbsent(Type type, ObjectReader objectReader, boolean fieldBased) {
<b class="fc">&nbsp;        ConcurrentMap&lt;Type, ObjectReader&gt; cache = fieldBased ? this.cacheFieldBased : this.cache;</b>
<b class="fc">&nbsp;        return cache.putIfAbsent(type, objectReader);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader unregisterObjectReader(Type type) {
<b class="fc">&nbsp;        return unregisterObjectReader(type, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader unregisterObjectReader(Type type, boolean fieldBased) {
<b class="fc">&nbsp;        ConcurrentMap&lt;Type, ObjectReader&gt; cache = fieldBased ? this.cacheFieldBased : this.cache;</b>
<b class="fc">&nbsp;        return cache.remove(type);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean unregisterObjectReader(Type type, ObjectReader reader) {
<b class="fc">&nbsp;        return unregisterObjectReader(type, reader, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean unregisterObjectReader(Type type, ObjectReader reader, boolean fieldBased) {
<b class="fc">&nbsp;        ConcurrentMap&lt;Type, ObjectReader&gt; cache = fieldBased ? this.cacheFieldBased : this.cache;</b>
<b class="fc">&nbsp;        return cache.remove(type, reader);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean register(ObjectReaderModule module) {
<b class="fc">&nbsp;        for (int i = modules.size() - 1; i &gt;= 0; i--) {</b>
<b class="fc">&nbsp;            if (modules.get(i) == module) {</b>
<b class="fc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        module.init(this);</b>
&nbsp;
<b class="fc">&nbsp;        modules.add(0, module);</b>
<b class="fc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean unregister(ObjectReaderModule module) {
<b class="fc">&nbsp;        return modules.remove(module);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void cleanup(Class objectClass) {
<b class="fc">&nbsp;        mixInCache.remove(objectClass);</b>
<b class="fc">&nbsp;        cache.remove(objectClass);</b>
<b class="fc">&nbsp;        cacheFieldBased.remove(objectClass);</b>
<b class="fc">&nbsp;        for (ConcurrentHashMap&lt;Long, ObjectReader&gt; tlc : tclHashCaches.values()) {</b>
<b class="nc">&nbsp;            for (Iterator&lt;Map.Entry&lt;Long, ObjectReader&gt;&gt; it = tlc.entrySet().iterator(); it.hasNext(); ) {</b>
<b class="nc">&nbsp;                Map.Entry&lt;Long, ObjectReader&gt; entry = it.next();</b>
<b class="nc">&nbsp;                ObjectReader reader = entry.getValue();</b>
<b class="nc">&nbsp;                if (reader.getObjectClass() == objectClass) {</b>
<b class="nc">&nbsp;                    it.remove();</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }</b>
<b class="fc">&nbsp;        BeanUtils.cleanupCache(objectClass);</b>
&nbsp;    }
&nbsp;
&nbsp;    static boolean match(Type objectType, ObjectReader objectReader, ClassLoader classLoader) {
<b class="fc">&nbsp;        Class&lt;?&gt; objectClass = TypeUtils.getClass(objectType);</b>
<b class="fc">&nbsp;        if (objectClass != null &amp;&amp; objectClass.getClassLoader() == classLoader) {</b>
<b class="fc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (objectType instanceof ParameterizedType) {</b>
<b class="fc">&nbsp;            ParameterizedType paramType = (ParameterizedType) objectType;</b>
<b class="fc">&nbsp;            Type rawType = paramType.getRawType();</b>
<b class="fc">&nbsp;            if (match(rawType, objectReader, classLoader)) {</b>
<b class="fc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            for (Type argType : paramType.getActualTypeArguments()) {</b>
<b class="fc">&nbsp;                if (match(argType, objectReader, classLoader)) {</b>
<b class="fc">&nbsp;                    return true;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (objectReader instanceof ObjectReaderImplMapTyped) {</b>
<b class="fc">&nbsp;            ObjectReaderImplMapTyped mapTyped = (ObjectReaderImplMapTyped) objectReader;</b>
<b class="fc">&nbsp;            Class valueClass = mapTyped.valueClass;</b>
<b class="fc">&nbsp;            if (valueClass != null &amp;&amp; valueClass.getClassLoader() == classLoader) {</b>
<b class="fc">&nbsp;                return true;</b>
&nbsp;            }
<b class="fc">&nbsp;            Class keyClass = TypeUtils.getClass(mapTyped.keyType);</b>
<b class="fc">&nbsp;            return keyClass != null &amp;&amp; keyClass.getClassLoader() == classLoader;</b>
<b class="fc">&nbsp;        } else if (objectReader instanceof ObjectReaderImplList) {</b>
<b class="fc">&nbsp;            ObjectReaderImplList list = (ObjectReaderImplList) objectReader;</b>
<b class="fc">&nbsp;            return list.itemClass != null &amp;&amp; list.itemClass.getClassLoader() == classLoader;</b>
<b class="fc">&nbsp;        } else if (objectReader instanceof ObjectReaderImplOptional) {</b>
<b class="fc">&nbsp;            Class itemClass = ((ObjectReaderImplOptional) objectReader).itemClass;</b>
<b class="fc">&nbsp;            return itemClass != null &amp;&amp; itemClass.getClassLoader() == classLoader;</b>
<b class="fc">&nbsp;        } else if (objectReader instanceof ObjectReaderAdapter) {</b>
<b class="fc">&nbsp;            FieldReader[] fieldReaders = ((ObjectReaderAdapter&lt;?&gt;) objectReader).fieldReaders;</b>
<b class="fc">&nbsp;            for (FieldReader fieldReader : fieldReaders) {</b>
<b class="fc">&nbsp;                if (fieldReader.fieldClass != null &amp;&amp; fieldReader.fieldClass.getClassLoader() == classLoader) {</b>
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                }
<b class="fc">&nbsp;                Type fieldType = fieldReader.fieldType;</b>
<b class="fc">&nbsp;                if (fieldType instanceof ParameterizedType) {</b>
<b class="fc">&nbsp;                    if (match(fieldType, null, classLoader)) {</b>
<b class="fc">&nbsp;                        return true;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void cleanup(ClassLoader classLoader) {
<b class="fc">&nbsp;        mixInCache.entrySet().removeIf(</b>
<b class="fc">&nbsp;                entry -&gt; entry.getKey().getClassLoader() == classLoader</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        cache.entrySet().removeIf(</b>
<b class="fc">&nbsp;                entry -&gt; match(entry.getKey(), entry.getValue(), classLoader)</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        cacheFieldBased.entrySet().removeIf(</b>
<b class="fc">&nbsp;                entry -&gt; match(entry.getKey(), entry.getValue(), classLoader)</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        int tclHash = System.identityHashCode(classLoader);</b>
<b class="fc">&nbsp;        tclHashCaches.remove(tclHash);</b>
&nbsp;
<b class="fc">&nbsp;        BeanUtils.cleanupCache(classLoader);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReaderCreator getCreator() {
<b class="fc">&nbsp;        ObjectReaderCreator contextCreator = JSONFactory.getContextReaderCreator();</b>
<b class="fc">&nbsp;        if (contextCreator != null) {</b>
<b class="fc">&nbsp;            return contextCreator;</b>
&nbsp;        }
<b class="fc">&nbsp;        return this.creator;</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public ObjectReaderProvider() {</b>
<b class="fc">&nbsp;        ObjectReaderCreator creator = null;</b>
<b class="fc">&nbsp;        switch (JSONFactory.CREATOR) {</b>
&nbsp;            case &quot;reflect&quot;:
&nbsp;            case &quot;lambda&quot;:
<b class="nc">&nbsp;                creator = ObjectReaderCreator.INSTANCE;</b>
<b class="nc">&nbsp;                break;</b>
&nbsp;            case &quot;asm&quot;:
&nbsp;            default:
&nbsp;                try {
<b class="fc">&nbsp;                    if (!JDKUtils.ANDROID &amp;&amp; !JDKUtils.GRAAL) {</b>
<b class="fc">&nbsp;                        creator = ObjectReaderCreatorASM.INSTANCE;</b>
&nbsp;                    }
<b class="nc">&nbsp;                } catch (Throwable ignored) {</b>
&nbsp;                    // ignored
<b class="fc">&nbsp;                }</b>
<b class="fc">&nbsp;                if (creator == null) {</b>
<b class="nc">&nbsp;                    creator = ObjectReaderCreator.INSTANCE;</b>
&nbsp;                }
&nbsp;                break;
&nbsp;        }
<b class="fc">&nbsp;        this.creator = creator;</b>
&nbsp;
<b class="fc">&nbsp;        modules.add(new ObjectReaderBaseModule(this));</b>
<b class="fc">&nbsp;        init();</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    public ObjectReaderProvider(ObjectReaderCreator creator) {</b>
<b class="fc">&nbsp;        this.creator = creator;</b>
<b class="fc">&nbsp;        modules.add(new ObjectReaderBaseModule(this));</b>
<b class="fc">&nbsp;        init();</b>
&nbsp;    }
&nbsp;
&nbsp;    void init() {
<b class="fc">&nbsp;        for (ObjectReaderModule module : modules) {</b>
<b class="fc">&nbsp;            module.init(this);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public Function getTypeConvert(Type from, Type to) {
<b class="fc">&nbsp;        Map&lt;Type, Function&gt; map = typeConverts.get(from);</b>
<b class="fc">&nbsp;        if (map == null) {</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        return map.get(to);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Function registerTypeConvert(Type from, Type to, Function typeConvert) {
<b class="fc">&nbsp;        Map&lt;Type, Function&gt; map = typeConverts.get(from);</b>
<b class="fc">&nbsp;        if (map == null) {</b>
<b class="fc">&nbsp;            typeConverts.putIfAbsent(from, new ConcurrentHashMap&lt;&gt;());</b>
<b class="fc">&nbsp;            map = typeConverts.get(from);</b>
&nbsp;        }
<b class="fc">&nbsp;        return map.put(to, typeConvert);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader getObjectReader(long hashCode) {
<b class="fc">&nbsp;        ObjectReaderCachePair pair = readerCache;</b>
<b class="fc">&nbsp;        if (pair != null) {</b>
<b class="fc">&nbsp;            if (pair.hashCode == hashCode) {</b>
<b class="fc">&nbsp;                return pair.reader;</b>
&nbsp;            } else {
<b class="fc">&nbsp;                if (pair.missCount++ &gt; 16) {</b>
<b class="fc">&nbsp;                    readerCache = null;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Long hashCodeObj = new Long(hashCode);</b>
<b class="fc">&nbsp;        ObjectReader objectReader = null;</b>
<b class="fc">&nbsp;        ClassLoader tcl = Thread.currentThread().getContextClassLoader();</b>
<b class="fc">&nbsp;        if (tcl != null &amp;&amp; tcl != FASTJSON2_CLASS_LOADER) {</b>
<b class="fc">&nbsp;            int tclHash = System.identityHashCode(tcl);</b>
<b class="fc">&nbsp;            ConcurrentHashMap&lt;Long, ObjectReader&gt; tclHashCache = tclHashCaches.get(tclHash);</b>
<b class="fc">&nbsp;            if (tclHashCache != null) {</b>
<b class="fc">&nbsp;                objectReader = tclHashCache.get(hashCodeObj);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (objectReader == null) {</b>
<b class="fc">&nbsp;            objectReader = hashCache.get(hashCodeObj);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (objectReader != null &amp;&amp; readerCache == null) {</b>
<b class="fc">&nbsp;            readerCache = new ObjectReaderCachePair(hashCode, objectReader);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return objectReader;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader getObjectReader(String typeName, Class&lt;?&gt; expectClass, long features) {
<b class="fc">&nbsp;        Class&lt;?&gt; autoTypeClass = checkAutoType(typeName, expectClass, features);</b>
<b class="fc">&nbsp;        if (autoTypeClass == null) {</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        boolean fieldBased = (features &amp; JSONReader.Feature.FieldBased.mask) != 0;</b>
<b class="fc">&nbsp;        ObjectReader objectReader = getObjectReader(autoTypeClass, fieldBased);</b>
&nbsp;
<b class="fc">&nbsp;        if (autoTypeClass != expectClass) {</b>
<b class="fc">&nbsp;            registerIfAbsent(Fnv.hashCode64(typeName), objectReader);</b>
&nbsp;        }
<b class="fc">&nbsp;        return objectReader;</b>
&nbsp;    }
&nbsp;
&nbsp;    final void afterAutoType(String typeName, Class type) {
<b class="fc">&nbsp;        if (autoTypeHandler != null) {</b>
<b class="fc">&nbsp;            autoTypeHandler.accept(type);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        synchronized (autoTypeList) {</b>
<b class="fc">&nbsp;            autoTypeList.putIfAbsent(typeName, new Date());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, long features) {
<b class="fc">&nbsp;        if (typeName == null || typeName.isEmpty()) {</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (autoTypeBeforeHandler != null) {</b>
<b class="fc">&nbsp;            Class&lt;?&gt; resolvedClass = autoTypeBeforeHandler.apply(typeName, expectClass, features);</b>
<b class="fc">&nbsp;            if (resolvedClass != null) {</b>
<b class="fc">&nbsp;                afterAutoType(typeName, resolvedClass);</b>
<b class="fc">&nbsp;                return resolvedClass;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (SAFE_MODE) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        int typeNameLength = typeName.length();</b>
<b class="fc">&nbsp;        if (typeNameLength &gt;= 192) {</b>
<b class="fc">&nbsp;            throw new JSONException(&quot;autoType is not support. &quot; + typeName);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (typeName.charAt(0) == &#39;[&#39;) {</b>
<b class="fc">&nbsp;            String componentTypeName = typeName.substring(1);</b>
<b class="fc">&nbsp;            checkAutoType(componentTypeName, null, features); // blacklist check for componentType</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (expectClass != null &amp;&amp; expectClass.getName().equals(typeName)) {</b>
<b class="fc">&nbsp;            afterAutoType(typeName, expectClass);</b>
<b class="fc">&nbsp;            return expectClass;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        boolean autoTypeSupport = (features &amp; JSONReader.Feature.SupportAutoType.mask) != 0;</b>
&nbsp;        Class&lt;?&gt; clazz;
&nbsp;
<b class="fc">&nbsp;        if (autoTypeSupport) {</b>
<b class="fc">&nbsp;            long hash = MAGIC_HASH_CODE;</b>
<b class="fc">&nbsp;            for (int i = 0; i &lt; typeNameLength; ++i) {</b>
<b class="fc">&nbsp;                char ch = typeName.charAt(i);</b>
<b class="fc">&nbsp;                if (ch == &#39;$&#39;) {</b>
<b class="fc">&nbsp;                    ch = &#39;.&#39;;</b>
&nbsp;                }
<b class="fc">&nbsp;                hash ^= ch;</b>
<b class="fc">&nbsp;                hash *= MAGIC_PRIME;</b>
<b class="fc">&nbsp;                if (Arrays.binarySearch(acceptHashCodes, hash) &gt;= 0) {</b>
<b class="fc">&nbsp;                    clazz = loadClass(typeName);</b>
<b class="fc">&nbsp;                    if (clazz != null) {</b>
<b class="fc">&nbsp;                        if (expectClass != null &amp;&amp; !expectClass.isAssignableFrom(clazz)) {</b>
<b class="fc">&nbsp;                            throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</b>
&nbsp;                        }
&nbsp;
<b class="fc">&nbsp;                        afterAutoType(typeName, clazz);</b>
<b class="fc">&nbsp;                        return clazz;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (!autoTypeSupport) {</b>
<b class="fc">&nbsp;            long hash = MAGIC_HASH_CODE;</b>
<b class="fc">&nbsp;            for (int i = 0; i &lt; typeNameLength; ++i) {</b>
<b class="fc">&nbsp;                char ch = typeName.charAt(i);</b>
<b class="fc">&nbsp;                if (ch == &#39;$&#39;) {</b>
<b class="fc">&nbsp;                    ch = &#39;.&#39;;</b>
&nbsp;                }
<b class="fc">&nbsp;                hash ^= ch;</b>
<b class="fc">&nbsp;                hash *= MAGIC_PRIME;</b>
&nbsp;
&nbsp;                // white list
<b class="fc">&nbsp;                if (Arrays.binarySearch(acceptHashCodes, hash) &gt;= 0) {</b>
<b class="fc">&nbsp;                    clazz = loadClass(typeName);</b>
&nbsp;
<b class="fc">&nbsp;                    if (clazz != null &amp;&amp; expectClass != null &amp;&amp; !expectClass.isAssignableFrom(clazz)) {</b>
<b class="fc">&nbsp;                        throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</b>
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    afterAutoType(typeName, clazz);</b>
<b class="fc">&nbsp;                    return clazz;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (!autoTypeSupport) {</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        clazz = TypeUtils.getMapping(typeName);</b>
&nbsp;
<b class="fc">&nbsp;        if (clazz != null) {</b>
<b class="fc">&nbsp;            if (expectClass != null</b>
&nbsp;                    &amp;&amp; expectClass != Object.class
&nbsp;                    &amp;&amp; clazz != java.util.HashMap.class
<b class="fc">&nbsp;                    &amp;&amp; !expectClass.isAssignableFrom(clazz)</b>
&nbsp;            ) {
<b class="fc">&nbsp;                throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            afterAutoType(typeName, clazz);</b>
<b class="fc">&nbsp;            return clazz;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        clazz = loadClass(typeName);</b>
&nbsp;
<b class="fc">&nbsp;        if (clazz != null) {</b>
<b class="fc">&nbsp;            if (ClassLoader.class.isAssignableFrom(clazz) || JDKUtils.isSQLDataSourceOrRowSet(clazz)) {</b>
<b class="fc">&nbsp;                throw new JSONException(&quot;autoType is not support. &quot; + typeName);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (expectClass != null) {</b>
<b class="fc">&nbsp;                if (expectClass.isAssignableFrom(clazz)) {</b>
<b class="fc">&nbsp;                    afterAutoType(typeName, clazz);</b>
<b class="fc">&nbsp;                    return clazz;</b>
&nbsp;                } else {
<b class="fc">&nbsp;                    if ((features &amp; JSONReader.Feature.IgnoreAutoTypeNotMatch.mask) != 0) {</b>
<b class="fc">&nbsp;                        return expectClass;</b>
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    throw new JSONException(&quot;type not match. &quot; + typeName + &quot; -&gt; &quot; + expectClass.getName());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        afterAutoType(typeName, clazz);</b>
<b class="fc">&nbsp;        return clazz;</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;ObjectReaderModule&gt; getModules() {
<b class="nc">&nbsp;        return modules;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void getBeanInfo(BeanInfo beanInfo, Class objectClass) {
<b class="fc">&nbsp;        for (ObjectReaderModule module : modules) {</b>
<b class="fc">&nbsp;            module.getBeanInfo(beanInfo, objectClass);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public void getFieldInfo(FieldInfo fieldInfo, Class objectClass, Field field) {
<b class="fc">&nbsp;        for (ObjectReaderModule module : modules) {</b>
<b class="fc">&nbsp;            module.getFieldInfo(fieldInfo, objectClass, field);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public void getFieldInfo(
&nbsp;            FieldInfo fieldInfo,
&nbsp;            Class objectClass,
&nbsp;            Constructor constructor,
&nbsp;            int paramIndex,
&nbsp;            Parameter parameter
&nbsp;    ) {
<b class="fc">&nbsp;        for (ObjectReaderModule module : modules) {</b>
<b class="fc">&nbsp;            ObjectReaderAnnotationProcessor annotationProcessor = module.getAnnotationProcessor();</b>
<b class="fc">&nbsp;            if (annotationProcessor != null) {</b>
<b class="fc">&nbsp;                annotationProcessor.getFieldInfo(fieldInfo, objectClass, constructor, paramIndex, parameter);</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public void getFieldInfo(
&nbsp;            FieldInfo fieldInfo,
&nbsp;            Class objectClass,
&nbsp;            Method method,
&nbsp;            int paramIndex,
&nbsp;            Parameter parameter) {
<b class="fc">&nbsp;        for (ObjectReaderModule module : modules) {</b>
<b class="fc">&nbsp;            ObjectReaderAnnotationProcessor annotationProcessor = module.getAnnotationProcessor();</b>
<b class="fc">&nbsp;            if (annotationProcessor != null) {</b>
<b class="fc">&nbsp;                annotationProcessor.getFieldInfo(fieldInfo, objectClass, method, paramIndex, parameter);</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader getObjectReader(Type objectType) {
<b class="fc">&nbsp;        return getObjectReader(objectType, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Function&lt;Consumer, ByteArrayValueConsumer&gt; createValueConsumerCreator(
&nbsp;            Class objectClass,
&nbsp;            FieldReader[] fieldReaderArray
&nbsp;    ) {
<b class="fc">&nbsp;        return creator.createByteArrayValueConsumerCreator(objectClass, fieldReaderArray);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Function&lt;Consumer, CharArrayValueConsumer&gt; createCharArrayValueConsumerCreator(
&nbsp;            Class objectClass,
&nbsp;            FieldReader[] fieldReaderArray
&nbsp;    ) {
<b class="fc">&nbsp;        return creator.createCharArrayValueConsumerCreator(objectClass, fieldReaderArray);</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectReader getObjectReader(Type objectType, boolean fieldBased) {
<b class="fc">&nbsp;        if (objectType == null) {</b>
<b class="fc">&nbsp;            objectType = Object.class;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        ObjectReader objectReader = fieldBased</b>
<b class="fc">&nbsp;                ? cacheFieldBased.get(objectType)</b>
<b class="fc">&nbsp;                : cache.get(objectType);</b>
&nbsp;
<b class="fc">&nbsp;        return objectReader != null</b>
&nbsp;                ? objectReader
<b class="fc">&nbsp;                : getObjectReaderInternal(objectType, fieldBased);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ObjectReader getObjectReaderInternal(Type objectType, boolean fieldBased) {
<b class="fc">&nbsp;        ObjectReader objectReader = null;</b>
&nbsp;
<b class="fc">&nbsp;        for (ObjectReaderModule module : modules) {</b>
<b class="fc">&nbsp;            objectReader = module.getObjectReader(this, objectType);</b>
<b class="fc">&nbsp;            if (objectReader != null) {</b>
<b class="fc">&nbsp;                ObjectReader previous = fieldBased</b>
<b class="fc">&nbsp;                        ? cacheFieldBased.putIfAbsent(objectType, objectReader)</b>
<b class="fc">&nbsp;                        : cache.putIfAbsent(objectType, objectReader);</b>
&nbsp;
<b class="fc">&nbsp;                if (previous != null) {</b>
<b class="nc">&nbsp;                    objectReader = previous;</b>
&nbsp;                }
<b class="fc">&nbsp;                return objectReader;</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        if (objectType instanceof TypeVariable) {</b>
<b class="fc">&nbsp;            Type[] bounds = ((TypeVariable&lt;?&gt;) objectType).getBounds();</b>
<b class="fc">&nbsp;            if (bounds.length &gt; 0) {</b>
<b class="fc">&nbsp;                Type bound = bounds[0];</b>
<b class="fc">&nbsp;                if (bound instanceof Class) {</b>
<b class="fc">&nbsp;                    ObjectReader boundObjectReader = getObjectReader(bound, fieldBased);</b>
<b class="fc">&nbsp;                    if (boundObjectReader != null) {</b>
<b class="fc">&nbsp;                        ObjectReader previous = getPreviousObjectReader(fieldBased, objectType, boundObjectReader);</b>
<b class="fc">&nbsp;                        if (previous != null) {</b>
<b class="nc">&nbsp;                            boundObjectReader = previous;</b>
&nbsp;                        }
<b class="fc">&nbsp;                        return boundObjectReader;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (objectType instanceof ParameterizedType) {</b>
<b class="fc">&nbsp;            ParameterizedType parameterizedType = (ParameterizedType) objectType;</b>
<b class="fc">&nbsp;            Type rawType = parameterizedType.getRawType();</b>
<b class="fc">&nbsp;            Type[] typeArguments = parameterizedType.getActualTypeArguments();</b>
<b class="fc">&nbsp;            if (rawType instanceof Class) {</b>
<b class="fc">&nbsp;                Class rawClass = (Class) rawType;</b>
&nbsp;
<b class="fc">&nbsp;                boolean generic = false;</b>
<b class="fc">&nbsp;                for (Class clazz = rawClass; clazz != Object.class; clazz = clazz.getSuperclass()) {</b>
<b class="fc">&nbsp;                    if (clazz.getTypeParameters().length &gt; 0) {</b>
<b class="fc">&nbsp;                        generic = true;</b>
<b class="fc">&nbsp;                        break;</b>
&nbsp;                    }
&nbsp;                }
<b class="fc">&nbsp;                if (typeArguments.length == 0 || !generic) {</b>
<b class="fc">&nbsp;                    ObjectReader rawClassReader = getObjectReader(rawClass, fieldBased);</b>
<b class="fc">&nbsp;                    if (rawClassReader != null) {</b>
<b class="fc">&nbsp;                        ObjectReader previous = getPreviousObjectReader(fieldBased, objectType, rawClassReader);</b>
<b class="fc">&nbsp;                        if (previous != null) {</b>
<b class="nc">&nbsp;                            rawClassReader = previous;</b>
&nbsp;                        }
<b class="fc">&nbsp;                        return rawClassReader;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Class&lt;?&gt; objectClass = TypeUtils.getMapping(objectType);</b>
&nbsp;
<b class="fc">&nbsp;        String className = objectClass.getName();</b>
<b class="fc">&nbsp;        if (!fieldBased) {</b>
<b class="fc">&nbsp;            if (className.equals(&quot;com.google.common.collect.ArrayListMultimap&quot;)) {</b>
<b class="fc">&nbsp;                objectReader = ObjectReaderImplMap.of(null, objectClass, 0);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (objectReader == null) {</b>
<b class="fc">&nbsp;            boolean jsonCompiled = false;</b>
<b class="fc">&nbsp;            Annotation[] annotations = objectClass.getAnnotations();</b>
<b class="fc">&nbsp;            for (Annotation annotation : annotations) {</b>
<b class="fc">&nbsp;                Class&lt;? extends Annotation&gt; annotationType = annotation.annotationType();</b>
<b class="fc">&nbsp;                jsonCompiled = annotationType.getName().equals(&quot;com.alibaba.fastjson2.annotation.JSONCompiled&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            if (jsonCompiled) {</b>
<b class="nc">&nbsp;                String codeGenClassName = objectClass.getName() + &quot;_FASTJOSNReader&quot;;</b>
<b class="nc">&nbsp;                ClassLoader classLoader = objectClass.getClassLoader();</b>
<b class="nc">&nbsp;                if (classLoader == null) {</b>
<b class="nc">&nbsp;                    classLoader = Thread.currentThread().getContextClassLoader();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (classLoader == null) {</b>
<b class="nc">&nbsp;                    classLoader = this.getClass().getClassLoader();</b>
&nbsp;                }
&nbsp;
&nbsp;                try {
<b class="nc">&nbsp;                    Class&lt;?&gt; loadedClass = classLoader.loadClass(codeGenClassName);</b>
<b class="nc">&nbsp;                    if (ObjectReader.class.isAssignableFrom(loadedClass)) {</b>
<b class="nc">&nbsp;                        objectReader = (ObjectReader) loadedClass.newInstance();</b>
&nbsp;                    }
<b class="nc">&nbsp;                } catch (Exception ignored) {</b>
&nbsp;                    // ignored
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;
&nbsp;            // objectClass.getResource(objectClass.)
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (objectReader == null) {</b>
<b class="fc">&nbsp;            ObjectReaderCreator creator = getCreator();</b>
<b class="fc">&nbsp;            objectReader = creator.createObjectReader(objectClass, objectType, fieldBased, this);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        ObjectReader previous = getPreviousObjectReader(fieldBased, objectType, objectReader);</b>
<b class="fc">&nbsp;        if (previous != null) {</b>
<b class="nc">&nbsp;            objectReader = previous;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return objectReader;</b>
&nbsp;    }
&nbsp;
&nbsp;    private ObjectReader getPreviousObjectReader(boolean fieldBased, Type objectType, ObjectReader boundObjectReader) {
<b class="fc">&nbsp;        return fieldBased</b>
<b class="fc">&nbsp;                ? cacheFieldBased.putIfAbsent(objectType, boundObjectReader)</b>
<b class="fc">&nbsp;                : cache.putIfAbsent(objectType, boundObjectReader);</b>
&nbsp;    }
&nbsp;
&nbsp;    public AutoTypeBeforeHandler getAutoTypeBeforeHandler() {
<b class="fc">&nbsp;        return autoTypeBeforeHandler;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Map&lt;String, Date&gt; getAutoTypeList() {
<b class="fc">&nbsp;        return autoTypeList;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setAutoTypeBeforeHandler(AutoTypeBeforeHandler autoTypeBeforeHandler) {
<b class="fc">&nbsp;        this.autoTypeBeforeHandler = autoTypeBeforeHandler;</b>
&nbsp;    }
&nbsp;
&nbsp;    static class LRUAutoTypeCache
&nbsp;            extends LinkedHashMap&lt;String, Date&gt; {
&nbsp;        private final int maxSize;
&nbsp;
&nbsp;        public LRUAutoTypeCache(int maxSize) {
<b class="fc">&nbsp;            super(16, 0.75f, false);</b>
<b class="fc">&nbsp;            this.maxSize = maxSize;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected boolean removeEldestEntry(Map.Entry&lt;String, Date&gt; eldest) {
<b class="fc">&nbsp;            return this.size() &gt; this.maxSize;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void getFieldInfo(FieldInfo fieldInfo, Class objectClass, Method method) {
<b class="fc">&nbsp;        for (ObjectReaderModule module : modules) {</b>
<b class="fc">&nbsp;            ObjectReaderAnnotationProcessor annotationProcessor = module.getAnnotationProcessor();</b>
<b class="fc">&nbsp;            if (annotationProcessor == null) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="fc">&nbsp;            annotationProcessor.getFieldInfo(fieldInfo, objectClass, method);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        if (fieldInfo.fieldName == null &amp;&amp; fieldInfo.alternateNames == null) {</b>
<b class="fc">&nbsp;            String methodName = method.getName();</b>
<b class="fc">&nbsp;            if (methodName.startsWith(&quot;set&quot;)) {</b>
<b class="fc">&nbsp;                String findName = methodName.substring(3);</b>
<b class="fc">&nbsp;                Field field = BeanUtils.getDeclaredField(objectClass, findName);</b>
<b class="fc">&nbsp;                if (field != null) {</b>
<b class="fc">&nbsp;                    fieldInfo.alternateNames = new String[]{findName};</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public &lt;T&gt; Supplier&lt;T&gt; createObjectCreator(Class&lt;T&gt; objectClass, long readerFeatures) {
<b class="fc">&nbsp;        boolean fieldBased = (readerFeatures &amp; JSONReader.Feature.FieldBased.mask) != 0;</b>
<b class="fc">&nbsp;        ObjectReader objectReader = fieldBased</b>
<b class="nc">&nbsp;                ? cacheFieldBased.get(objectClass)</b>
<b class="fc">&nbsp;                : cache.get(objectClass);</b>
<b class="fc">&nbsp;        if (objectReader != null) {</b>
<b class="fc">&nbsp;            return () -&gt; (T) objectReader.createInstance(0);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Constructor constructor = BeanUtils.getDefaultConstructor(objectClass, false);</b>
<b class="fc">&nbsp;        if (constructor == null) {</b>
<b class="nc">&nbsp;            throw new JSONException(&quot;default constructor not found : &quot; + objectClass.getName());</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return LambdaMiscCodec.createSupplier(constructor);</b>
&nbsp;    }
&nbsp;
&nbsp;    public FieldReader createFieldReader(Class objectClass, String fieldName, long readerFeatures) {
<b class="fc">&nbsp;        boolean fieldBased = (readerFeatures &amp; JSONReader.Feature.FieldBased.mask) != 0;</b>
&nbsp;
<b class="fc">&nbsp;        ObjectReader objectReader = fieldBased</b>
<b class="nc">&nbsp;                ? cacheFieldBased.get(objectClass)</b>
<b class="fc">&nbsp;                : cache.get(objectClass);</b>
&nbsp;
<b class="fc">&nbsp;        if (objectReader != null) {</b>
<b class="fc">&nbsp;            return objectReader.getFieldReader(fieldName);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        AtomicReference&lt;Field&gt; fieldRef = new AtomicReference&lt;&gt;();</b>
<b class="fc">&nbsp;        long nameHashLCase = Fnv.hashCode64LCase(fieldName);</b>
<b class="fc">&nbsp;        BeanUtils.fields(objectClass, field -&gt; {</b>
<b class="fc">&nbsp;            if (nameHashLCase == Fnv.hashCode64LCase(field.getName())) {</b>
<b class="fc">&nbsp;                fieldRef.set(field);</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="fc">&nbsp;        Field field = fieldRef.get();</b>
<b class="fc">&nbsp;        if (field != null) {</b>
<b class="fc">&nbsp;            return creator.createFieldReader(fieldName, null, field.getType(), field);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        AtomicReference&lt;Method&gt; methodRef = new AtomicReference&lt;&gt;();</b>
<b class="fc">&nbsp;        BeanUtils.setters(objectClass, method -&gt; {</b>
<b class="fc">&nbsp;            String setterName = BeanUtils.setterName(method.getName(), PropertyNamingStrategy.CamelCase.name());</b>
<b class="fc">&nbsp;            if (nameHashLCase == Fnv.hashCode64LCase(setterName)) {</b>
<b class="fc">&nbsp;                methodRef.set(method);</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="fc">&nbsp;        Method method = methodRef.get();</b>
<b class="fc">&nbsp;        if (method != null) {</b>
<b class="fc">&nbsp;            Class&lt;?&gt;[] params = method.getParameterTypes();</b>
<b class="fc">&nbsp;            Class fieldClass = params[0];</b>
<b class="fc">&nbsp;            return creator.createFieldReaderMethod(objectClass, fieldName, null, fieldClass, fieldClass, method);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;T&gt; ObjectReader&lt;T&gt; createObjectReader(
&nbsp;            String[] names,
&nbsp;            Type[] types,
&nbsp;            Supplier&lt;T&gt; supplier,
&nbsp;            FieldConsumer&lt;T&gt; c
&nbsp;    ) {
<b class="fc">&nbsp;        return createObjectReader(names, types, null, supplier, c);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;T&gt; ObjectReader&lt;T&gt; createObjectReader(
&nbsp;            String[] names,
&nbsp;            Type[] types,
&nbsp;            long[] features,
&nbsp;            Supplier&lt;T&gt; supplier,
&nbsp;            FieldConsumer&lt;T&gt; c
&nbsp;    ) {
<b class="fc">&nbsp;        FieldReader[] fieldReaders = new FieldReader[names.length];</b>
<b class="fc">&nbsp;        for (int i = 0; i &lt; names.length; i++) {</b>
<b class="fc">&nbsp;            Type fieldType = types[i];</b>
<b class="fc">&nbsp;            Class fieldClass = TypeUtils.getClass(fieldType);</b>
<b class="fc">&nbsp;            long feature = features != null &amp;&amp; i &lt; features.length ? features[i] : 0;</b>
<b class="fc">&nbsp;            fieldReaders[i] = creator.createFieldReader(</b>
&nbsp;                    names[i],
&nbsp;                    fieldType,
&nbsp;                    fieldClass,
&nbsp;                    feature,
&nbsp;                    new FieldBiConsumer(i, c)
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return creator.createObjectReader(</b>
&nbsp;                null,
&nbsp;                supplier,
&nbsp;                fieldReaders
&nbsp;        );
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-09 23:27</div>
</div>
</body>
</html>
