[<Line: +package org.stagemonitor.core.metrics.metrics2;
>, <Line: +import java.io.IOException;
>, <Line: +import java.util.Collections;
>, <Line: +import java.util.Map;
>, <Line: +import java.util.concurrent.TimeUnit;
>, <Line: +import com.codahale.metrics.Counter;
>, <Line: +import com.codahale.metrics.Gauge;
>, <Line: +import com.codahale.metrics.Histogram;
>, <Line: +import com.codahale.metrics.Meter;
>, <Line: +import com.codahale.metrics.Metered;
>, <Line: +import com.codahale.metrics.Metric;
>, <Line: +import com.codahale.metrics.Snapshot;
>, <Line: +import com.codahale.metrics.Timer;
>, <Line: +import com.fasterxml.jackson.core.JsonGenerator;
>, <Line: +import com.fasterxml.jackson.core.Version;
>, <Line: +import com.fasterxml.jackson.databind.JsonSerializer;
>, <Line: +import com.fasterxml.jackson.databind.Module;
>, <Line: +import com.fasterxml.jackson.databind.SerializerProvider;
>, <Line: +import com.fasterxml.jackson.databind.module.SimpleSerializers;
>, <Line: +import com.fasterxml.jackson.databind.ser.std.StdSerializer;
>, <Line: +import com.fasterxml.jackson.databind.type.TypeFactory;
>, <Line: +public class Metric2RegistryModule extends Module {
>, <Line: +	private final double rateFactor;
>, <Line: +	private final double durationFactor;
>, <Line: +	private final Metric2Filter filter;
>, <Line: +	public Metric2RegistryModule(TimeUnit rateUnit, TimeUnit durationUnit) {
>, <Line: +		this(rateUnit, durationUnit, Metric2Filter.ALL);
>, <Line: +	}
>, <Line: +	public Metric2RegistryModule(TimeUnit rateUnit, TimeUnit durationUnit, Metric2Filter filter) {
>, <Line: +		this.rateFactor = rateUnit.toSeconds(1);
>, <Line: +		this.durationFactor = 1.0 / durationUnit.toNanos(1);
>, <Line: +		this.filter = filter;
>, <Line: +	}
>, <Line: +	@Override
>, <Line: +	public String getModuleName() {
>, <Line: +		return "stagemonitor";
>, <Line: +	}
>, <Line: +	@Override
>, <Line: +	public Version version() {
>, <Line: +		return new Version(1, 0, 0, "", "org.stagemonitor", "stagemonitor-core");
>, <Line: +	}
>, <Line: +	@Override
>, <Line: +	public void setupModule(SetupContext context) {
>, <Line: +		context.addSerializers(new SimpleSerializers(Collections.<JsonSerializer<?>>singletonList(new Metric2RegistrySerializer())));
>, <Line: +	}
>, <Line: +	private class Metric2RegistrySerializer extends StdSerializer<Metric2Registry> {
>, <Line: +		public Metric2RegistrySerializer() {
>, <Line: +			super(Metric2Registry.class);
>, <Line: +		}
>, <Line: +		@Override
>, <Line: +		public void serialize(Metric2Registry value, JsonGenerator gen, SerializerProvider provider) throws IOException {
>, <Line: +			gen.writeStartArray();
>, <Line: +			new MetricSerializer<Gauge>(Gauge.class, new GaugeValueWriter()).serialize(value.getGauges(filter), gen, provider);
>, <Line: +			new MetricSerializer<Counter>(Counter.class, new CounterValueWriter()).serialize(value.getCounters(filter), gen, provider);
>, <Line: +			new MetricSerializer<Histogram>(Histogram.class, new HistogramValueWriter()).serialize(value.getHistograms(filter), gen, provider);
>, <Line: +			new MetricSerializer<Meter>(Meter.class, new MeterValueWriter()).serialize(value.getMeters(filter), gen, provider);
>, <Line: +			new MetricSerializer<Timer>(Timer.class, new TimerValueWriter()).serialize(value.getTimers(filter), gen, provider);
>, <Line: +			gen.writeEndArray();
>, <Line: +		}
>, <Line: +	}
>, <Line: +	private class MetricSerializer<T extends Metric> extends StdSerializer<Map<MetricName, T>> {
>, <Line: +		private final ValueWriter<T> valueWriter;
>, <Line: +		public MetricSerializer(Class<T> metricType, ValueWriter<T> valueWriter) {
>, <Line: +			super(TypeFactory.defaultInstance().constructMapType(Map.class, MetricName.class, metricType));
>, <Line: +			this.valueWriter = valueWriter;
>, <Line: +		}
>, <Line: +		@Override
>, <Line: +		public void serialize(Map<MetricName, T> value, JsonGenerator gen, SerializerProvider provider) throws IOException {
>, <Line: +			for (Map.Entry<MetricName, T> entry : value.entrySet()) {
>, <Line: +				gen.writeStartObject();
>, <Line: +				MetricName metricName = entry.getKey();
>, <Line: +				gen.writeStringField("name", metricName.getName());
>, <Line: +				for (Map.Entry<String, String> tagEntry : metricName.getTags().entrySet()) {
>, <Line: +					gen.writeObjectField(tagEntry.getKey(), tagEntry.getValue());
>, <Line: +				}
>, <Line: +				valueWriter.writeValues(entry.getValue(), gen);
>, <Line: +				gen.writeEndObject();
>, <Line: +			}
>, <Line: +		}
>, <Line: +	}
>, <Line: +	public <T extends Metric> ValueWriter<T> getValueWriter(Class<T> metricClass) {
>, <Line: +		if (Gauge.class == metricClass) {
>, <Line: +			return (ValueWriter<T>) new GaugeValueWriter();
>, <Line: +		} else if (Counter.class == metricClass) {
>, <Line: +			return (ValueWriter<T>) new CounterValueWriter();
>, <Line: +		} else if (Histogram.class == metricClass) {
>, <Line: +			return (ValueWriter<T>) new HistogramValueWriter();
>, <Line: +		} else if (Meter.class == metricClass) {
>, <Line: +			return (ValueWriter<T>) new MeterValueWriter();
>, <Line: +		} else if (Timer.class == metricClass) {
>, <Line: +			return (ValueWriter<T>) new TimerValueWriter();
>, <Line: +		} else {
>, <Line: +			throw new IllegalArgumentException("Unknown metric class: " + metricClass);
>, <Line: +		}
>, <Line: +	}
>, <Line: +	public interface ValueWriter<T extends Metric> {
>, <Line: +		void writeValues(T value, JsonGenerator jg) throws IOException;
>, <Line: +	}
>, <Line: +	private class GaugeValueWriter implements ValueWriter<Gauge> {
>, <Line: +		public void writeValues(Gauge gauge, JsonGenerator jg) throws IOException {
>, <Line: +			final Object value = gauge.getValue();
>, <Line: +			if (value == null) {
>, <Line: +				return;
>, <Line: +			}
>, <Line: +			if (value instanceof Number) {
>, <Line: +				writeDoubleUnlessNaN(jg, "value", ((Number) value).doubleValue());
>, <Line: +			} else if (value instanceof Boolean) {
>, <Line: +				jg.writeBooleanField("value_boolean", (Boolean) value);
>, <Line: +			} else {
>, <Line: +				jg.writeStringField("value_string", value.toString());
>, <Line: +			}
>, <Line: +		}
>, <Line: +	}
>, <Line: +	private class CounterValueWriter implements ValueWriter<Counter> {
>, <Line: +		public void writeValues(Counter counter, JsonGenerator jg) throws IOException {
>, <Line: +			jg.writeObjectField("count", counter.getCount());
>, <Line: +		}
>, <Line: +	}
>, <Line: +	private class HistogramValueWriter implements ValueWriter<Histogram> {
>, <Line: +		public void writeValues(Histogram histogram, JsonGenerator jg) throws IOException {
>, <Line: +			final Snapshot snapshot = histogram.getSnapshot();
>, <Line: +			jg.writeNumberField("count", histogram.getCount());
>, <Line: +			writeSnapshot(snapshot, jg);
>, <Line: +		}
>, <Line: +	}
>, <Line: +	private class MeterValueWriter implements ValueWriter<Meter> {
>, <Line: +		public void writeValues(Meter meter, JsonGenerator jg) throws IOException {
>, <Line: +			writeMetered(meter, jg);
>, <Line: +		}
>, <Line: +	}
>, <Line: +	private class TimerValueWriter implements ValueWriter<Timer> {
>, <Line: +		public void writeValues(Timer timer, JsonGenerator jg) throws IOException {
>, <Line: +			writeMetered(timer, jg);
>, <Line: +			writeSnapshot(timer.getSnapshot(), jg);
>, <Line: +		}
>, <Line: +	}
>, <Line: +	private void writeSnapshot(Snapshot snapshot, JsonGenerator jg) throws IOException {
>, <Line: +		writeDoubleUnlessNaN(jg, "min", convertDuration(snapshot.getMin()));
>, <Line: +		writeDoubleUnlessNaN(jg, "max", convertDuration(snapshot.getMax()));
>, <Line: +		writeDoubleUnlessNaN(jg, "mean", convertDuration(snapshot.getMean()));
>, <Line: +		writeDoubleUnlessNaN(jg, "median", convertDuration(snapshot.getMedian()));
>, <Line: +		writeDoubleUnlessNaN(jg, "std", convertDuration(snapshot.getStdDev()));
>, <Line: +		writeDoubleUnlessNaN(jg, "p25", convertDuration(snapshot.getValue(0.25)));
>, <Line: +		writeDoubleUnlessNaN(jg, "p75", convertDuration(snapshot.get75thPercentile()));
>, <Line: +		writeDoubleUnlessNaN(jg, "p95", convertDuration(snapshot.get95thPercentile()));
>, <Line: +		writeDoubleUnlessNaN(jg, "p98", convertDuration(snapshot.get98thPercentile()));
>, <Line: +		writeDoubleUnlessNaN(jg, "p99", convertDuration(snapshot.get99thPercentile()));
>, <Line: +		writeDoubleUnlessNaN(jg, "p999", convertDuration(snapshot.get999thPercentile()));
>, <Line: +	}
>, <Line: +	private void writeMetered(Metered metered, JsonGenerator jg) throws IOException {
>, <Line: +		jg.writeNumberField("count", metered.getCount());
>, <Line: +		writeDoubleUnlessNaN(jg, "m1_rate", convertRate(metered.getOneMinuteRate()));
>, <Line: +		writeDoubleUnlessNaN(jg, "m5_rate", convertRate(metered.getFiveMinuteRate()));
>, <Line: +		writeDoubleUnlessNaN(jg, "m15_rate", convertRate(metered.getFifteenMinuteRate()));
>, <Line: +		writeDoubleUnlessNaN(jg, "mean_rate", convertRate(metered.getMeanRate()));
>, <Line: +	}
>, <Line: +	private void writeDoubleUnlessNaN(JsonGenerator jg, String key, double value) throws IOException {
>, <Line: +		if (!Double.isNaN(value)) {
>, <Line: +			jg.writeNumberField(key, value);
>, <Line: +		}
>, <Line: +	}
>, <Line: +	private double convertDuration(double duration) {
>, <Line: +		return duration * durationFactor;
>, <Line: +	}
>, <Line: +	private double convertRate(double rate) {
>, <Line: +		return rate * rateFactor;
>, <Line: +	}
>, <Line: +}
>]
[]